<!DOCTYPE html>
<html>
<head>
    <title>Encuestas App</title>
 
    <meta name="viewport" content="width=device-width, initial-scale=1">
 
    <link rel="stylesheet" href="js/jquery.mobile.structure-1.4.2.min.css" />
    <link rel="stylesheet" href="js/jquery.mobile-1.4.2.min.css" />
    <link rel="stylesheet" href="js/jquery.mobile.theme-1.4.2.min.css" />
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="js/jquery.mobile-1.4.2.min.js"></script>
    <script src="js/cordova.js"></script>
    <script src="js/dump.js"></script>
    
</head>

<style type="text/css">
	.ui-page.ui-body-c {
	    background: url(ugr_background.png);
	    background-repeat:no-repeat;
	    background-position:center center;
	    background-size:cover;  
	}
</style>


 
<body>

<!-- PAGINA LOGIN -->
<div data-role="page" id="inicio" data-theme="b">
    
    <!-- CABECERA -->
	<div data-role="header">
        <h1>Encuestas App</h1>
    </div>
 
 		<!-- CONTENIDO -->
	<form id="formulario" >
  
  		<label> Usuario </label>
  		<input type="text" id="nombredeusuario" name="nombredeusuario">
  
  		<label> Password </label>
 		<input type="password" id="clave" name="clave" >
 			
 		<input type="submit" value="Login" id="botonLogin" data-theme="a">
  
	</form>	
</div>

<!-- PAGINA HOME -->   
<div data-role="page" id="home" data-theme="b">
 
	<div data-role="header" data-position="inline">
		<a href="#inicio" data-icon="delete" data-theme="a" class="ui-btn-left">Logout</a>
		<h1>Bienvenido</h1>
	</div>
	
	<div data-role="collapsible-set" id="grupo_cursos">	
	<!-- SE GENERA EL CONTENIDO -->
	</div>
	
	<!-- PIE DE PAGINA -->
	<div data-role="footer" data-id="foo2" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#home" data-icon="home" class="ui-btn-active ui-state-persist">Encuestas</a></li>
				<li><a href="#acercade" data-icon="info" >Acerca de</a></li>
			</ul>
		</div><!-- /navbar -->
	</div>
 
</div>

<!-- PAGINA INFO ENCUESTA -->
<div data-role="page" id="info-fb" data-theme="b">
 
	<div data-role="header" data-position="inline">
		<a href="#inicio" data-icon="delete" data-theme="a" class="ui-btn-left">Logout</a>
		<h1>Bienvenido</h1>
	</div>
	
	<div data-role="content" id="info">	
	<!-- SE GENERA EL CONTENIDO -->
	</div>
	
	<!-- PIE DE PAGINA -->
	<div data-role="footer" data-id="foo2" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#home" data-icon="home" class="ui-btn-active ui-state-persist">Encuestas</a></li>
				<li><a href="#acercade" data-icon="info" >Acerca de</a></li>
			</ul>
		</div><!-- /navbar -->
	</div>
 
</div>

<!-- PAGINA FEEDBACK -->
<div data-role="page" id="fb" data-theme="b">
 
	<div data-role="header" data-position="inline">
		<a href="#inicio" data-icon="delete" data-theme="a" class="ui-btn-left">Logout</a>
		<h1>Bienvenido</h1>
	</div>
	
	<div data-role="content" id="fb_content">	
	<!-- SE GENERA EL CONTENIDO -->
	</div>
 
</div>

<!-- PAGINA ACERCA DE -->   
<div data-role="page" id="acercade" data-theme="b">
 
	<div data-role="header" data-position="inline">
		<a href="#inicio" data-icon="delete" data-theme="a" class="ui-btn-left">Logout</a>
		<h1>Bienvenido</h1>
	</div>
	
	<!-- PIE DE PAGINA -->
	<div data-role="footer" data-id="foo2" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#home" data-icon="home">Encuestas</a></li>
				<li><a href="#acercade" data-icon="info" class="ui-btn-active ui-state-persist">Acerca de</a></li>
			</ul>
		</div><!-- /navbar -->
	</div>
 
</div>

<!-- DIALOG -->
<div data-role="page" id="dialog">

	<div data-role="header" data-theme="d" data-position="inline">
		<h1>Error</h1>

	</div>

	<div data-role="content" data-theme="c">
		<h1>Titulo</h1>
		<p>Texto</p>
		<a href="docs-dialogs.html" data-role="button" data-rel="back" data-theme="b">Sounds good</a>       
		<a href="docs-dialogs.html" data-role="button" data-rel="back" data-theme="c">Cancel</a>    
	</div>
</div>


<script>

// ---datos estaticos globales---
var username = "";
var mytoken = 0;
var URL = "http://tamen.ugr.es/ugrmoodle";
var WS_short_name = 'ws_encuestas';

// INICIO
$('#formulario').submit(function() {
	
	/*login();
	moodleWSCall("local_wstemplate_hello_world", {}, function(data_courses){
	            		
	});*/	
	
	
	
	// Realizamos login y obtenemos el token del usuario
	login();
  	
		// Obtenemos la informacion del usuario: cursos y sus encuestas asociadas
		// Cargamos recursos de la siguiente pagina:
		
		// 1º Obtenemos el ID del usuario haciendo una busqueda por su usuario
		//var aux = [];
		//aux[0] = username;
		//var data_user = moodleWSCall("core_user_get_users_by_field", {field: 'username', values: aux});
		//moodleWSCall("core_user_get_users_by_field", {field: 'username', values: aux});
		
		//MODO CALLBACK
		//moodleWSCall("core_user_get_users_by_field", {field: 'username', values: aux}, function(data_user){
		moodleWSCall("core_webservice_get_site_info", {}, function(data_user){
    		//Do something with data_user
    		//alert("CALLBACK"+dump(data_user));
    		// Nos devuelve una lista de cursos con la info justa (no incluye al curso "general")
    		moodleWSCall("core_enrol_get_users_courses", {userid: data_user.userid}, function(user_courses){
    			//alert("CALLBACK2"+dump(user_courses));
    			
    			// Nos devuelve todos los contenidos de los cursos de manera detallada (esto nos puede servir para presentar
    			//	las encuestas por temas del curso, pero en principio no lo vamos a incluir)
    			//moodleWSCall("core_course_get_contents", {courseid: user_courses[0].id}, function(data_courses){
    			
    			// Creamos una lista de IDs de los cursos (incluyendo las encuestas generales del curso ID=1)
				id_cursos = null;
				id_cursos = [];
				id_cursos[0] = 1;
				for(var i=0; i<user_courses.length; i++){
					// Excluimos los cursos ocultos
					if(user_courses[i].visible)
						id_cursos[i+1] = user_courses[i].id;
				}
				//alert(dump(aux));

				moodleWSCall("local_fbplugin_get_feedbacks_by_courses", {courseids: id_cursos}, function(feedbacks){
        		
        			// Obtenemos la lista de IDs de los cursos actualizada solo con los cursos 
        			// que tengan alguna encuesta 
        			id_cursos = null;
					id_cursos = [];
					var nombres_cursos = [];
					var fb_cursos = [];
					var fb_generales = [];
					var fb_curso = false;
        			for(var i=0; i<feedbacks.length; i++){
        				// Es encuesta general
        				if(feedbacks[i].course == 1){
        					fb_generales.push(feedbacks[i]);
        				}
        				else{
							for(var j=0; j<user_courses.length && !fb_curso; j++){
								if(feedbacks[i].course == user_courses[j].id){
									fb_cursos.push(feedbacks[i]);
									nombres_cursos.push(user_courses[j].shortname);
									fb_curso = true;
								}
							}
							fb_curso = false;
						}
					}
					
					//alert(dump(nombres_cursos));
					
					// Creamos los elementos HTML de HOME
					var grupo_cursos = document.getElementById("grupo_cursos");
					
					// Si hay algun feedback que mostrar..
					if(feedbacks.length != 0){	
						// FB generales
						for(var i=0; i<fb_generales.length; i++){
							var a = document.createElement("a");
							// Si no hacemos esto, devolvera un valor de i cualquiera
							a.onclick = (function() {
								var currentI = i;
								return function() { 
							    	cargarPaginaInfo(currentI, fb_generales);
								}
							})();
							a.setAttribute('data-role', 'button');
							a.setAttribute('data-icon', 'carat-r');
							var texto = document.createTextNode(fb_generales[i].name);
							a.appendChild(texto);
							grupo_cursos.appendChild(a);
						}
						
						// FB cursos
						for(var i=0; i<fb_cursos.length; i++){
							var div = document.createElement("div");
							div.setAttribute('data-role', 'collapsible');
							div.setAttribute('id', nombres_cursos[i]);
							div.innerHTML = "<h3>" + nombres_cursos[i] + "</h3>";
							var a = document.createElement("a");
							a.onclick = (function() {
								var currentI = i;
								return function() { 
							    	cargarPaginaInfo(currentI, fb_cursos);
								}
							})();
							a.setAttribute('data-role', 'button');
							a.setAttribute('data-icon', 'carat-r');
							var texto = document.createTextNode(fb_cursos[i].name);
							a.appendChild(texto);
							div.appendChild(a);
							grupo_cursos.appendChild(div);
						}
					}
					else{
						var div = document.createElement("div");
						div.setAttribute('data-role', 'content');
						div.innerHTML = "<p>Vaya, en estos momentos no tienes ninguna encuesta asociada a tu perfil.</p>";
						grupo_cursos.appendChild(div);
					}
					
					
					
					
					
        			
	    			//document.getElementById("cursos").innerHTML = cursos;
	    			// Cambiamos la pagina a "home"
	            	$.mobile.changePage("#home",{allowSamePageTransition:true,reloadPage:false,changeHash:true,transition:"slide"});
	            		
	            	
            		//moodleWSCall("local_fbplugin_get_feedback_questions", {feedbackid: 1}, function(fb_questions){
            			
            			/*aux = null;
            			var aux = [];
						aux[0] = 21; // ID
						aux[1] = 2;	// value
						aux[2] = "multichoice";// type
						
						var aux2 = [];
						aux2[0] = aux;*/
						
						var aux2 = [{
							itemid: 21,
                        	value: 1,
                        	typ: 'multichoice'}];
						
            			
	            		moodleWSCall("local_fbplugin_complete_feedback", {feedbackid: 3, itemvalues: aux2}, function(fb_questions){
	            		
	            		
	            		});
            		//});
            		
            	});	
	            	
	            
    		});
		});
		
	
	return false;
});

function cargarPaginaInfo(id_btn, fb){
	
	// Creamos los elementos de la pagina de información general de la encuesta
	var info = document.getElementById("info");
	info.innerHTML = "<h2>"+fb[id_btn].name+"</h2><h3>"+fb[id_btn].intro+"</h3>";
	
	// ANONYMOUS
	if(fb[id_btn].anonymous==1)
		info.innerHTML += "<dl><dt>Anónima: </dt><dd>Sí</dd>";
	else
		info.innerHTML += "<dl><dt>Anónima: </dt><dd>No</dd>";
		
	// MULTICHOICE
	if(fb[id_btn].multiple_submit==1)
		info.innerHTML += "<dt>Multi-respuesta: </dt><dd>Sí</dd>";
	else
		info.innerHTML += "<dt>Multi-respuesta: </dt><dd>No</dd>";
		
	// TIME OPEN-CLOSE
	if(fb[id_btn].timeopen==0)
		info.innerHTML += "<dt>Encuesta abierta: </dt><dd>Sí</dd>";
	else{
		// Si la encuesta esta cerrada
		var current_time=new Date().getTime();
		if(fb[id_btn].timeopen > current_time || (fb[id_btn].timeclose < current_time && fb[id_btn].timeclose > 0))
			info.innerHTML += "<dt>Encuesta abierta: </dt><dd>No</dd>";
		else{
			var date_open = new Date(fb[id_btn].timeopen);
			var date_open = new Date(fb[id_btn].timeclose);
			
			info.innerHTML += "<p>Abierta desde el "+data_open.getDate()+"//"+date_open.getMonth()+"//"+date_open.getFullYear()+
			" a las "+date_open.getHours()+":"+date_open.getMinutes()+":"+date_open.getSeconds()+" horas hasta el "+data_open.getDate()+
			"//"+date_open.getMonth()+"//"+date_open.getFullYear()+" a las "+date_open.getHours()+":"+date_open.getMinutes()+":"+date_open.getSeconds()+"</p>";
		}
	}
	
	// Boton comenzar encuesta
	var a = document.createElement("a");
	a.onclick = (function() {
		var currentId = id_btn;
		return function() { 
	    	cargarFB(currentId, fb);
		}
	})();
	a.setAttribute('href', '#fb');
	a.setAttribute('data-role', 'button');
	a.setAttribute('data-icon', 'carat-r');
	var texto = document.createTextNode("Comenzar Encuesta");
	a.appendChild(texto);
	info.appendChild(a);
	
	//alert(id_btn);
	$.mobile.changePage("#info-fb",{allowSamePageTransition:true,reloadPage:false,changeHash:true,transition:"slide"});
}

function cargarFB(id_btn, fb){
	
	// Cargar preguntas
	moodleWSCall("local_fbplugin_get_feedback_questions", {feedbackid: fb[id_btn].id}, function(fb_questions){
		
		var fb_content = document.getElementById("fb_content");
		
		// Creamos los elementos del FB
		for(var i=0; i<fb_questions.lenght ;i++){
			
			if(fb.questions.typ == "multichoice"){
				
				// Creamos el fieldset
				var fieldset = document.createElement("fieldset");
				fieldset.setAttribute('data-role', 'controlgroup');
				
				// Creamos legend (enunciado pregunta)
				var legend = document.createElement("legend");
				legend.innerHTML = "";
				
				// Estructura del presentation:
				// d>>>>>: lista desplegable
				// r>>>>>: seleccion radio
				// c>>>>>: check button
				
				// Cada respuesta
				for(var j=0; j<fb.questions ; j++){
					
					var input = document.createElement("input");
					input.setAttribute('type', 'radio');
					input.setAttribute('id', 'radio');
					input.setAttribute('value', '1');
					var label = document.createElement("label");
					label.setAttribute('for', '');
					label.innerHTML = "";
					
				}
				
				
				
				fb_content.innerHTML =
				
				
			}
			<fieldset data-role="controlgroup">
    		<legend>Radio buttons, vertical controlgroup:</legend>
		
		
		}
		
		
	});
	
}

// Login
function login(){
	
	// Datos usuario
    username = $("#nombredeusuario").val();
    var password = $("#clave").val();
    var loginURL = URL+'/login/token.php';

    // Intentamos obtener un token valido
	$.ajax({
		async: false,
	    url:loginURL,
	    type:'POST',
	    data:{
	    	username: username,
	        password: password,
	        service: WS_short_name
    },
    dataType:"json",
    
    success:function(respuesta) {
        if (typeof(respuesta.token) != 'undefined') {
        	
        	// Almacenamos el token
        	mytoken = respuesta.token;
            alert("Login correcto, su token es:"+mytoken);
            
		}else {
			//$.mobile.changePage("#dialog")
            var error = "Invalid account";

            if (typeof(respuesta.error) != 'undefined') {
                error = respuesta.error;
            }
            alert("Login incorrecto:"+error);
        }
        return;
    },
        
    error:function(xhr, textStatus, errorThrown) {
        error = "No es posible la conexión."
        if (xhr.status == 404) {
            error = "Error 404";
        }
        alert("Problema de red:"+error);
        return;
    }
    });

	return false;
}


/**
 * Checks if the device is connected to Internet
 * We use Cordova API for that, if the config setting "dev_offline" is set we return allways not connected.
 *
 * @return {boolean} True if the device is connected.
 */
function deviceConnected() {
    var connected = true;

    var network = navigator.network;
    if (typeof(network) != 'undefined') {
        var networkState = network.connection.type;
        connected = (networkState != Connection.NONE && networkState != Connection.UNKNOWN);

    }
    return connected;
}

/**
 * A wrapper function for a moodle WebService call.
 *
 * @param {string} method The WebService method to be called.
 * @param {Object} data Arguments to pass to the method.
 */
function moodleWSCall(method, json, callback) {

    json.wsfunction = method;
    json.wstoken = mytoken;
    json.moodlewsrestformat = 'json';       
	
	//alert(dump(json));
	
    var wsURL = URL+'/webservice/rest/server.php';

    // If we arrive here, and we are not connected, thrown a network error message.
    // Si no hay conexion, lanzamos un error
    /*if (!deviceConnected()) {
        alert("Problema de red");
    }*/
    
    //...loading...

    // Main jQuery Ajax call, returns in json format.
    return $.ajax({
        type: 'POST',
        data: json,
        url: wsURL,

        success: function(data) {
        	alert(dump(data));
        	
        	// Si no obtenemos ninguna respuesta del WS
            if (!data) {
                //MM.popErrorMessage(MM.lang.s("cannotconnect"));
            }
			
			// Si devuelve un error..
            if (typeof(data.exception) != 'undefined') {
            	//cerrar loading
                if (data.errorcode == "invalidtoken" || data.errorcode == "accessexception") {
                    // Conexion perdida
                    $.mobile.changePage("#inicio");
                    return;
                } else {
                	alert('Error. ' + data.message);
                }
                return;
            }

            if (typeof(data.debuginfo) != 'undefined') {
            	// cerrar loading
                alert('Error. ' + data.message);
                return;
            }

			// Si todo ha ido bien, obtenemos nuestro data
            //if (typeof(data) == 'object' && typeof(data.length) != 'undefined') {
            if (typeof(data) == 'object') {
                //var longitud_datos = data.length;
                //getData(data);
                //alert("TDO HA IDO BIEN"+dump(data));
                callback(data);
                return data;
            }

            // cerrar loading
        },
        
        error: function(xhr, ajaxOptions, thrownError) {

			//alert("error:"+dump(data));
            // cerrar loading

            var error = "Problema de conexion"
            if (xhr.status == 404) {
                error = "Esquema no valido";
            }
            
            alert('WS: error on ' + method + ' error: ' + error);
    	}
	});
}



</script>

</body>
</html>

